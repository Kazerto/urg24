rules_version = '2';

// R√®gles de s√©curit√© Firebase Storage pour URG24
// Ces r√®gles prot√®gent vos donn√©es tout en permettant les op√©rations n√©cessaires

service firebase.storage {
  match /b/{bucket}/o {

    // ========================================
    // HELPER FUNCTIONS (Fonctions utilitaires)
    // ========================================

    // V√©rifier si l'utilisateur est authentifi√©
    function isAuthenticated() {
      return request.auth != null;
    }

    // V√©rifier si l'utilisateur poss√®de l'UID sp√©cifi√©
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // V√©rifier si le fichier est une image
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }

    // V√©rifier la taille du fichier (max 10 MB)
    function isSizeValid() {
      return request.resource.size < 10 * 1024 * 1024;
    }

    // V√©rifier si l'utilisateur est admin (√† impl√©menter via custom claims)
    function isAdmin() {
      return request.auth.token.userType == 'admin';
    }

    // V√©rifier si l'utilisateur est pharmacie
    function isPharmacy() {
      return request.auth.token.userType == 'pharmacy';
    }


    // ========================================
    // R√àGLES D'ACC√àS PAR DOSSIER
    // ========================================

    // üìÑ ORDONNANCES (Prescriptions)
    // - Seul le client propri√©taire peut uploader
    // - Les pharmacies et admins peuvent lire
    match /prescriptions/{userId}/{fileName} {
      // Lecture: propri√©taire, pharmacies, admins
      allow read: if isAuthenticated() &&
                     (isOwner(userId) || isPharmacy() || isAdmin());

      // √âcriture: uniquement le propri√©taire
      allow write: if isAuthenticated() &&
                      isOwner(userId) &&
                      isImage() &&
                      isSizeValid();

      // Suppression: propri√©taire ou admin
      allow delete: if isAuthenticated() &&
                       (isOwner(userId) || isAdmin());
    }

    // üë§ PHOTOS DE PROFIL - CLIENTS
    match /profiles/client/{userId} {
      // Lecture: tout utilisateur authentifi√©
      allow read: if isAuthenticated();

      // √âcriture: uniquement le propri√©taire
      allow write: if isAuthenticated() &&
                      isOwner(userId) &&
                      isImage() &&
                      isSizeValid();

      // Suppression: propri√©taire ou admin
      allow delete: if isAuthenticated() &&
                       (isOwner(userId) || isAdmin());
    }

    // üöö PHOTOS DE PROFIL - LIVREURS
    match /profiles/delivery_person/{userId} {
      // Lecture: tout utilisateur authentifi√©
      allow read: if isAuthenticated();

      // √âcriture: uniquement le propri√©taire
      allow write: if isAuthenticated() &&
                      isOwner(userId) &&
                      isImage() &&
                      isSizeValid();

      // Suppression: propri√©taire ou admin
      allow delete: if isAuthenticated() &&
                       (isOwner(userId) || isAdmin());
    }

    // üè• PHOTOS DE PROFIL - PHARMACIES
    match /profiles/pharmacy/{pharmacyId} {
      // Lecture: tout utilisateur authentifi√©
      allow read: if isAuthenticated();

      // √âcriture: uniquement la pharmacie propri√©taire
      allow write: if isAuthenticated() &&
                      isOwner(pharmacyId) &&
                      isImage() &&
                      isSizeValid();

      // Suppression: propri√©taire ou admin
      allow delete: if isAuthenticated() &&
                       (isOwner(pharmacyId) || isAdmin());
    }

    // üíä PHOTOS DE M√âDICAMENTS
    match /medicaments/{pharmacyId}/{fileName} {
      // Lecture: tout utilisateur authentifi√©
      allow read: if isAuthenticated();

      // √âcriture: uniquement la pharmacie propri√©taire
      allow write: if isAuthenticated() &&
                      isOwner(pharmacyId) &&
                      isImage() &&
                      isSizeValid();

      // Suppression: propri√©taire ou admin
      allow delete: if isAuthenticated() &&
                       (isOwner(pharmacyId) || isAdmin());
    }

    // üè™ PHOTOS DE PHARMACIES
    match /pharmacies/{pharmacyId}/{fileName} {
      // Lecture: tout le monde (pour affichage public)
      allow read: if true;

      // √âcriture: uniquement la pharmacie propri√©taire
      allow write: if isAuthenticated() &&
                      isOwner(pharmacyId) &&
                      isImage() &&
                      isSizeValid();

      // Suppression: propri√©taire ou admin
      allow delete: if isAuthenticated() &&
                       (isOwner(pharmacyId) || isAdmin());
    }

    // ‚ùå BLOQUER TOUT LE RESTE
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
